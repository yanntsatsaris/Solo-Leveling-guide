<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Panoplies</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_panoplie.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_panoplie_modal.css') }}">
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='images/icon-onglet.png') }}"
    />
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container">
        <h1>Gestion des Panoplies</h1>
        <div style="text-align:center; margin-bottom: 24px;">
            <button id="create-panoplie-btn" class="admin-btn">Créer une nouvelle panoplie</button>
        </div>
        <table>
            <tr>
                <th>Image</th>
                <th>Nom</th>
                <th>Nom affiché</th>
            </tr>
            {% for panoplie in panoplies %}
            <tr>
                <td>
                    {% if panoplie.image %}
                        <a href="#" data-panoplie-name="{{ panoplie.name }}">
                            <img src="{{ panoplie.image }}" alt="{{ panoplie.display_name }}">
                        </a>
                    {% else %}
                        <span style="color:#ff3333;">Aucune image</span>
                    {% endif %}
                </td>
                <td>{{ panoplie.name }}</td>
                <td>{{ panoplie.display_name }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% include 'partials/edit_panoplie_modal.html' %}
    <script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('a[data-panoplie-name]').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const panoplieName = this.getAttribute('data-panoplie-name');
      fetch(`/admin/panoplie/api/${panoplieName}`)
        .then(resp => resp.json())
        .then(data => {
          const langDiv = document.getElementById('edit-panoplie-languages');
          langDiv.innerHTML = '';
          for (const [lang, trans] of Object.entries(data.translations)) {
            langDiv.innerHTML += `
              <fieldset>
                <legend>${lang}</legend>
                <label>Nom affiché :</label>
                <input type="text" name="display_name_${lang}" value="${trans.display_name || ''}" required>
                <h4>Effets</h4>
                <div>
                  ${(data.effects[lang] || []).map(effect =>
                    `<div class="effect-row"><b>${effect.pieces} pièces :</b>
                      <textarea name="effect_${lang}_${effect.pieces}" class="effect-input">${effect.effect || ''}</textarea>
                    </div>`
                  ).join('')}
                </div>
              </fieldset>
            `;
          }
          document.getElementById('edit-panoplie-overlay').style.display = 'flex';
          document.getElementById('edit-panoplie-form').action = `/admin/panoplie/${panoplieName}`;
          autoResizeAllTextareas();
        });
    });
  });

  // Fermer la modale en cliquant sur la croix
  document.getElementById('close-edit-panoplie').onclick = function() {
    document.getElementById('edit-panoplie-overlay').style.display = 'none';
  };

  // Fermer la modale en cliquant en dehors du menu
  document.getElementById('edit-panoplie-overlay').addEventListener('mousedown', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });

  // Fermer la modale avec la touche Échap
  document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      document.getElementById('edit-panoplie-overlay').style.display = 'none';
    }
  });

  // Création d'une nouvelle panoplie
  document.getElementById('create-panoplie-btn').onclick = async function() {
    let name = prompt("Nom interne de la nouvelle panoplie ?");
    if (!name) return;

    // Vérifie si la panoplie existe déjà
    let exists = false;
    {% for panoplie in panoplies %}
      if ("{{ panoplie.name|e }}" === name) exists = true;
    {% endfor %}
    if (exists) {
      alert("Une panoplie avec ce nom existe déjà !");
      return;
    }

    // Vérifie la présence d'au moins une image Artefact02 ou Artefact05
    let name_folder = name.replace(/ /g, "_");
    let img02 = `/static/images/Artefacts/${name_folder}/Artefact02_${name_folder}.webp`;
    let img05 = `/static/images/Artefacts/${name_folder}/Artefact05_${name_folder}.webp`;

    // Teste la présence d'au moins une image
    let imgExists = await fetch(img02, {method: "HEAD"}).then(r => r.ok).catch(() => false);
    if (!imgExists) {
      imgExists = await fetch(img05, {method: "HEAD"}).then(r => r.ok).catch(() => false);
    }
    if (!imgExists) {
      alert("Aucune image Artefact02 ou Artefact05 trouvée pour cette panoplie !");
      return;
    }

    // Prépare le menu d'édition vide pour FR et EN
    const langDiv = document.getElementById('edit-panoplie-languages');
    langDiv.innerHTML = '';
    ['FR-fr', 'EN-en'].forEach(function(lang) {
      langDiv.innerHTML += `
        <fieldset>
          <legend>${lang}</legend>
          <label>Nom affiché :</label>
          <input type="text" name="display_name_${lang}" value="" required>
          <h4>Effets</h4>
          <div>
            <div class="effect-row"><b>2 pièces :</b>
              <textarea name="effect_${lang}_2" class="effect-input"></textarea>
            </div>
            <div class="effect-row"><b>4 pièces :</b>
              <textarea name="effect_${lang}_4" class="effect-input"></textarea>
            </div>
          </div>
        </fieldset>
      `;
    });
    document.getElementById('edit-panoplie-overlay').style.display = 'flex';
    document.getElementById('edit-panoplie-form').action = `/admin/panoplie/${encodeURIComponent(name)}`;
    autoResizeAllTextareas();
  };
});
function autoResizeAllTextareas() {
  document.querySelectorAll("textarea.effect-input").forEach(function(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
  });
}
document.addEventListener("DOMContentLoaded", autoResizeAllTextareas);
// Si tu ajoutes dynamiquement des textarea, appelle autoResizeAllTextareas() après l'injection.
</script>
</body>
</html>