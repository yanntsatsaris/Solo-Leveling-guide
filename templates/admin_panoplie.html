<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Panoplies</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_panoplie.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_panoplie_modal.css') }}">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container">
        <h1>Gestion des Panoplies</h1>
        <table>
            <tr>
                <th>Image</th>
                <th>Nom</th>
                <th>Nom affiché</th>
            </tr>
            {% for panoplie in panoplies %}
            <tr>
                <td>
                    {% if panoplie.image %}
                        <a href="#" data-panoplie-name="{{ panoplie.name }}">
                            <img src="{{ panoplie.image }}" alt="{{ panoplie.display_name }}">
                        </a>
                    {% else %}
                        <span style="color:#ff3333;">Aucune image</span>
                    {% endif %}
                </td>
                <td>{{ panoplie.name }}</td>
                <td>{{ panoplie.display_name }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% include 'partials/edit_panoplie_modal.html' %}
    <script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('a[data-panoplie-name]').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const panoplieName = this.getAttribute('data-panoplie-name');
      fetch(`/admin/panoplie/api/${panoplieName}`)
        .then(resp => resp.json())
        .then(data => {
          const langDiv = document.getElementById('edit-panoplie-languages');
          langDiv.innerHTML = '';
          for (const [lang, trans] of Object.entries(data.translations)) {
            langDiv.innerHTML += `
              <fieldset>
                <legend>${lang}</legend>
                <label>Nom affiché :</label>
                <input type="text" name="display_name_${lang}" value="${trans.display_name || ''}" required>
                <h4>Effets</h4>
                <div>
                  ${(data.effects[lang] || []).map(effect =>
                    `<div class="effect-row"><b>${effect.pieces} pièces :</b>
                      <textarea name="effect_${lang}_${effect.pieces}" class="effect-input">${effect.effect || ''}</textarea>
                    </div>`
                  ).join('')}
                </div>
              </fieldset>
            `;
          }
          document.getElementById('edit-panoplie-overlay').style.display = 'flex';
          document.getElementById('edit-panoplie-form').action = `/admin/panoplie/${panoplieName}`;
          autoResizeAllTextareas();
        });
    });
  });

  // Fermer la modale en cliquant sur la croix
  document.getElementById('close-edit-panoplie').onclick = function() {
    document.getElementById('edit-panoplie-overlay').style.display = 'none';
  };

  // Fermer la modale en cliquant en dehors du menu
  document.getElementById('edit-panoplie-overlay').addEventListener('mousedown', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });

  // Fermer la modale avec la touche Échap
  document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      document.getElementById('edit-panoplie-overlay').style.display = 'none';
    }
  });
});
function autoResizeAllTextareas() {
  document.querySelectorAll("textarea.effect-input").forEach(function(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
  });
}
document.addEventListener("DOMContentLoaded", autoResizeAllTextareas);
// Si tu ajoutes dynamiquement des textarea, appelle autoResizeAllTextareas() après l'injection.
</script>
</body>
</html>