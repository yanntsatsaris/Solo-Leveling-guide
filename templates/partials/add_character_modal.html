<dialog id="add-character-modal">
  <article>
    <header>
      <h2 class="modal-title">Ajouter un personnage</h2>
      <button type="button" class="close-btn" data-close-modal>&times;</button>
    </header>
    <form
      id="add-character-form"
      method="POST"
      action="{{ url_for('characters.add_character') }}"
    >
      <nav class="edit-tabs">
        <button type="button" class="edit-tab active" data-tab="main">Infos principales</button>
        <button type="button" class="edit-tab" data-tab="passives">Passifs</button>
        <button type="button" class="edit-tab" data-tab="skills">Compétences</button>
        <button type="button" class="edit-tab" data-tab="weapons">Armes</button>
        <button type="button" class="edit-tab" data-tab="artefacts">Artefacts</button>
      </nav>

      <section class="edit-tab-content active" id="edit-tab-main">
        <label>Nom :</label>
        <input type="text" name="name" required />
        <label>Alias :</label>
        <input type="text" name="alias" required />
        <label>Type :</label>
        <input type="text" name="type" required />
        <label>Rareté :</label>
        <input type="text" name="rarity" required />
        <label>Description :</label>
        <textarea name="description"></textarea>
        <input type="hidden" name="image_folder" value="">

        <h4>Évolutions du personnage</h4>
        <div class="evolutions-grid">
          {% set total_evos = 7 %}
          {% for i in range(total_evos) %}
            {% if i % 2 == 0 %}<div class="evolutions-row">{% endif %}
              <div class="edit-evolution-block">
                <label>Évolution : {{ 'A' ~ i if not i == 6 else 'A6-10' }}</label>
                <textarea name="character_evolution_description_{{ i }}"></textarea>
                <input type="hidden" name="character_evolutions_{{ i }}_evolution_id" value="{{ 'A' ~ i if not i == 6 else 'A6-10' }}">
                <input type="hidden" name="character_evolutions_id_{{ i }}" value="">
              </div>
            {% if i % 2 == 1 or i == total_evos - 1 %}</div>{% endif %}
          {% endfor %}
        </div>
      </section>

      <section class="edit-tab-content" id="edit-tab-passives">
        <div class="passives-grid" id="passives-grid"></div>
        <button type="button" id="add-passive-btn" class="add-btn">+ Ajouter un passif</button>
      </section>

      <section class="edit-tab-content" id="edit-tab-skills">
        <div class="skills-grid" id="skills-grid"></div>
        <button type="button" id="add-skill-btn" class="add-btn">+ Ajouter une compétence</button>
      </section>

      <section class="edit-tab-content" id="edit-tab-weapons">
        {% for weapon_idx in range(1) %}
          <div class="edit-weapon-block">
            <label>Nom de l'arme :</label>
            <input type="text" name="weapon_name_{{ weapon_idx }}" />
            <label>Stats :</label>
            <textarea name="weapon_stats_{{ weapon_idx }}"></textarea>
            <label>Tag :</label>
            <input type="text" name="weapon_tag_{{ weapon_idx }}" />
            <label>Principal : <input type="checkbox" name="weapon_principal_{{ weapon_idx }}" /></label>
            <input type="hidden" name="weapon_id_{{ weapon_idx }}" value="">
            <h4>Évolutions de l'arme</h4>
            <div class="evolutions-grid">
              {% for i in range(7) %}
                {% if i % 2 == 0 %}<div class="evolutions-row">{% endif %}
                  <div class="edit-weapon-evolution-block">
                    <label>Évolution : {{ 'A' ~ i if not i == 6 else 'A6-10' }}</label>
                    <textarea name="weapon_evolution_description_{{ weapon_idx }}_{{ i }}"></textarea>
                    <input type="hidden" name="weapon_evolutions_{{ weapon_idx }}_{{ i }}_evolution_id" value="{{ 'A' ~ i if not i == 6 else 'A6-10' }}">
                    <input type="hidden" name="weapon_evolutions_id_{{ weapon_idx }}_{{ i }}" value="">
                  </div>
                {% if i % 2 == 1 or i == 6 %}</div>{% endif %}
              {% endfor %}
            </div>
          </div>
          <hr />
        {% endfor %}
      </section>

      <section class="edit-tab-content" id="edit-tab-artefacts">
        <div>
          <label for="add-equipment-select">Sélectionner le set :</label>
          <select id="add-equipment-select">
            <option value="add_new_set" class="add-new-set-option">+ Ajouter un nouveau set</option>
          </select>
        </div>
        <div id="add-artefacts-fields"></div>
      </section>

      <footer>
        <button type="submit" class="admin-btn">Enregistrer</button>
      </footer>
    </form>
  </article>
</dialog>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalData = {
      panopliesList: [
        {% for panoplie in panoplies_list %}"{{ panoplie }}"{% if not loop.last %},{% endif %}{% endfor %}
      ],
      artefactMainStats: {{ artefact_main_stats|tojson }},
      secondaryStatsOptions: {{ secondary_stats_options|tojson }},
      focusStatsOptions: {{ focus_stats_options|tojson }},
      coresList: [
        {% for core in cores_list %}"{{ core }}"{% if not loop.last %},{% endif %}{% endfor %}
      ],
      coreMainStats: {{ core_main_stats|tojson }},
      coreSecondaryStats: {{ core_secondary_stats|tojson }},
      currentLang: "{{ language if language is defined else 'FR-fr' }}"
    };
    if (typeof initializeAddCharacterModalData === 'function') {
      initializeAddCharacterModalData(modalData);
    }
  });
</script>
