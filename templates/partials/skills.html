<div id="skills" class="tab-content">
    <h2>Skills</h2>
    {% if character.alias == "SJW" %}
        {% if session.username and session.rights and ('Admin' in session.rights or 'SuperAdmin' in session.rights) %}
            <button id="add-sjw-skill-btn" class="admin-btn">
                Ajouter une compétence
            </button>
            {% include 'partials/add_sjw_skill_modal.html' %}
        {% endif %}
        <div class="sjw-inner-tabs">
            <div class="sjw-inner-tab-btns">
                <div class="sjw-inner-tab-btn active" data-inner-tab="Skill">Skills</div>
                <div class="sjw-inner-tab-btn" data-inner-tab="QTE">QTE</div>
                <div class="sjw-inner-tab-btn" data-inner-tab="Ultime">Ultime</div>
            </div>
            <div class="sjw-inner-tab-contents">
                
                {% for tab in ['Skill', 'QTE', 'Ultime'] %}
                <div class="sjw-inner-tab-content{% if loop.first %} active{% endif %}" id="sjw-inner-tab-{{ tab }}">
                    
                    <div class="sjw-skills-grid-wrapper">
                        <div class="sjw-skills-grid">
                            {% set skills = character.skills | selectattr('type', 'equalto', tab) | list %}
                            {% for skill in skills %}
                                <div class="sjw-skill-cell sjw-skill-clickable" data-skill-index="{{ loop.index0 }}">
                                    <div class="sjw-skill-image-row">
                                        {% if skill.image %}
                                            <img src="{{ url_for('static', filename=skill.image) }}" alt="Skill Image">
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="sjw-gems-sidebar" id="sjw-gems-sidebar" style="display:none;">
                            <h3>Gems du skill</h3>
                            <div id="sjw-gems-list"></div>
                        </div>
                    </div>
                    {% if skills|length == 0 %}
                        <p>Aucune compétence dans cette catégorie.</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        <script>
        document.addEventListener("DOMContentLoaded", function() {
            const innerTabBtns = document.querySelectorAll('.sjw-inner-tab-btn');
            const innerTabContents = document.querySelectorAll('.sjw-inner-tab-content');
            innerTabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    innerTabBtns.forEach(b => b.classList.remove('active'));
                    innerTabContents.forEach(tc => tc.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('sjw-inner-tab-' + this.dataset.innerTab).classList.add('active');
                });
            });

            // Gestion de l'affichage des gems à gauche
            const skillCells = document.querySelectorAll('.sjw-skill-clickable');
            const sidebar = document.getElementById('sjw-gems-sidebar');
            const gemsList = document.getElementById('sjw-gems-list');
            // Récupère les skills depuis le contexte Jinja
            const allSkillsData = {{ character.skills|tojson }};
            skillCells.forEach(cell => {
                cell.addEventListener('click', function() {
                    // Récupère l'onglet actif
                    const activeTab = document.querySelector('.sjw-inner-tab-btn.active').dataset.innerTab;
                    // Filtre les skills du bon type
                    const skillsData = allSkillsData.filter(s => s.type === activeTab);
                    const idx = parseInt(cell.dataset.skillIndex);
                    const skill = skillsData[idx];
                    gemsList.innerHTML = '';
                    if (skill && skill.gems) {
                        skill.gems.forEach(gem => {
                            const gemDiv = document.createElement('div');
                            gemDiv.className = 'sjw-gem-sidebar-bubble';
                            gemDiv.innerHTML = `
                                ${gem.image ? `<img src="/static/${gem.image}" alt="Gem Image" class="sjw-gem-sidebar-img">` : ''}
                            `;
                            gemsList.appendChild(gemDiv);
                        });
                        sidebar.style.display = '';
                    }
                });
            });
        });
        </script>
    {% else %}
        {# Section classique pour les autres personnages #}
        {% if character.skills and character.skills|length > 0 %}
            {% for skill in character.skills %}
                <div class="skill {% if skill.principal %}principal{% endif %}">
                    {% if skill.image %}
                        <img src="{{ url_for('static', filename=skill.image) }}" alt="{{ skill.name or 'Skill Image' }}">
                    {% endif %}
                    <div>
                        {% if skill.name %}
                            <strong>{{ skill.name }}</strong><br>
                        {% endif %}
                        <p>{{ skill.description|safe }}</p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>Informations sur les skills du personnage.</p>
        {% endif %}
    {% endif %}
</div>