<div id="skills" class="tab-content">
    <h2>Skills</h2>
    {% if character.alias == "SJW" %}
        {% if session.username and session.rights and ('Admin' in session.rights or 'SuperAdmin' in session.rights) %}
            <button id="add-sjw-skill-btn" class="admin-btn">
                Ajouter une compétence
            </button>
            {% include 'partials/add_sjw_skill_modal.html' %}
        {% endif %}
        <div class="sjw-inner-tabs">
            <div class="sjw-inner-tab-btns">
                <div class="sjw-inner-tab-btn active" data-inner-tab="Skill">Skills</div>
                <div class="sjw-inner-tab-btn" data-inner-tab="QTE">QTE</div>
                <div class="sjw-inner-tab-btn" data-inner-tab="Ultime">Ultime</div>
            </div>
            <div class="sjw-inner-tab-contents">
                
                {% for tab in ['Skill', 'QTE', 'Ultime'] %}
                <div class="sjw-inner-tab-content{% if loop.first %} active{% endif %}" id="sjw-inner-tab-{{ tab }}">
                    
                    <div class="sjw-skills-grid-wrapper">
                        <div class="sjw-skills-grid">
                            {% set skills = character.skills | selectattr('type', 'equalto', tab) | list %}
                            {% for skill in skills %}
                                <div class="sjw-skill-cell sjw-skill-clickable" data-skill-index="{{ loop.index0 }}">
                                    <div class="sjw-skill-image-row">
                                        {% if skill.image %}
                                            <img src="{{ url_for('static', filename=skill.image) }}" alt="Skill Image">
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <!-- Bulle flottante pour les gems -->
                        <div id="sjw-gems-bubble" class="sjw-gems-bubble" style="display:none; position:absolute;">
                            <div id="sjw-gems-bubble-list"></div>
                        </div>
                    </div>
                    {% if skills|length == 0 %}
                        <p>Aucune compétence dans cette catégorie.</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        <script>
        document.addEventListener("DOMContentLoaded", function() {
            const innerTabBtns = document.querySelectorAll('.sjw-inner-tab-btn');
            const innerTabContents = document.querySelectorAll('.sjw-inner-tab-content');
            innerTabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    innerTabBtns.forEach(b => b.classList.remove('active'));
                    innerTabContents.forEach(tc => tc.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('sjw-inner-tab-' + this.dataset.innerTab).classList.add('active');
                });
            });
        
        });

        document.addEventListener("DOMContentLoaded", function() {
        const skillCells = document.querySelectorAll('.sjw-skill-clickable');
        const gemsBubble = document.getElementById('sjw-gems-bubble');
        const gemsBubbleList = document.getElementById('sjw-gems-bubble-list');
        const allSkillsData = {{ character.skills|tojson }};

        skillCells.forEach(cell => {
            cell.addEventListener('click', function(event) {
                // Récupère l'onglet actif
                const activeTab = document.querySelector('.sjw-inner-tab-btn.active').dataset.innerTab;
                const skillsData = allSkillsData.filter(s => s.type === activeTab);
                const idx = parseInt(cell.dataset.skillIndex);
                const skill = skillsData[idx];
                gemsBubbleList.innerHTML = '';
                if (skill && skill.gems) {
                    skill.gems.forEach(gem => {
                        if (gem.image) {
                            const img = document.createElement('img');
                            img.src = "/static/" + gem.image;
                            img.className = "sjw-gem-bubble-img";
                            img.alt = "Gem Image";
                            gemsBubbleList.appendChild(img);
                        }
                    });
                    // Positionne la bulle à gauche du skill cliqué
                    const rect = cell.getBoundingClientRect();
                    const bubbleWidth = gemsBubble.offsetWidth || 120;
                    const bubbleHeight = gemsBubble.offsetHeight || 200;
                    let leftPosition = rect.left + window.scrollX - bubbleWidth - 16;
                    if (leftPosition < 0) {
                        leftPosition = rect.right + window.scrollX + 16;
                    }
                    let topPosition = rect.top + window.scrollY + (rect.height / 2) - (bubbleHeight / 2);
                    if (topPosition < 0) topPosition = 10;
                    gemsBubble.style.top = `${topPosition}px`;
                    gemsBubble.style.left = `${leftPosition}px`;
                    gemsBubble.style.display = "flex";
                }
            });
        });

        // Ferme la bulle si on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.sjw-skill-clickable') && !e.target.closest('#sjw-gems-bubble')) {
                gemsBubble.style.display = "none";
            }
        });
    });
        </script>
    {% else %}
        {# Section classique pour les autres personnages #}
        {% if character.skills and character.skills|length > 0 %}
            {% for skill in character.skills %}
                <div class="skill {% if skill.principal %}principal{% endif %}">
                    {% if skill.image %}
                        <img src="{{ url_for('static', filename=skill.image) }}" alt="{{ skill.name or 'Skill Image' }}">
                    {% endif %}
                    <div>
                        {% if skill.name %}
                            <strong>{{ skill.name }}</strong><br>
                        {% endif %}
                        <p>{{ skill.description|safe }}</p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>Informations sur les skills du personnage.</p>
        {% endif %}
    {% endif %}
</div>