<div
  id="edit-character-overlay"
  class="edit-character-overlay"
  style="display: none"
>
  <div id="edit-character-menu" class="edit-character-popup">
    <form
      id="edit-character-form"
      method="POST"
      action="{{ url_for('edit_character', char_id=character.id) }}"
    >
      <h2 style="text-align: center; color: #ffcc00">Modifier le personnage</h2>
      <div class="edit-tabs">
        <div class="edit-tab active" data-tab="main">Infos principales</div>
        <div class="edit-tab" data-tab="passives">Passifs</div>
        <div class="edit-tab" data-tab="skills">Compétences</div>
        <div class="edit-tab" data-tab="weapons">Armes</div>
        <div class="edit-tab" data-tab="artefacts">Artefacts</div>
      </div>
      <!-- Onglet Infos principales -->
      <div class="edit-tab-content active" id="edit-tab-main">
        <label>Nom :</label>
        <input type="text" name="name" value="{{ character.name }}" required />
        <label>Alias :</label>
        <input
          type="text"
          name="alias"
          value="{{ character.alias }}"
          required
        />
        <label>Type :</label>
        <input type="text" name="type" value="{{ character.type }}" required />
        <label>Rareté :</label>
        <input
          type="text"
          name="rarity"
          value="{{ character.rarity }}"
          required
        />
        <label>Description :</label>
        <textarea name="description" required>{{ character.description }}</textarea>
        <label>Image :</label>
        <input type="text" name="image" value="{{ character.image_name }}" />

        <h4 style="margin-top: 28px">Évolutions du personnage</h4>
        <div class="evolutions-grid">
          {% set total_evos = 7 %} {% for i in range(total_evos) %} {% if i % 2
          == 0 %}
          <div class="evolutions-row">
            {% endif %}
            <div class="edit-evolution-block">
              <label>Évolution : {{ 'A' ~ i if not i == 6 else 'A6-A10' }}</label>
              <textarea name="character_evolution_description_{{ i }}">{{ character.evolutions[i].description_raw if character.evolutions|length > i else '' }}</textarea>
              <input type="hidden" name="character_evolutions_{{ i }}_evolution_id" value="{{ character.evolutions[i].evolution_id }}">
              <input type="hidden" name="character_evolutions_id_{{ i }}" value="{{ character.evolutions[i].id }}">
            </div>
            {% if i % 2 == 1 or i == total_evos - 1 %}
          </div>
          {% endif %} {% endfor %}
        </div>
      </div>
      <!-- Onglet Passifs -->
      <div class="edit-tab-content" id="edit-tab-passives">
        <div class="passives-grid" id="passives-grid">
          {% for passive in character.passives_all %} {% if loop.index0 % 2 == 0
          %}
          <div class="passives-row">
            {% endif %}
            <!-- Exemple pour un passif, à appliquer aussi pour skills, weapons, etc. -->
            <div class="edit-passive-block">
              <label>Nom du passif :</label>
              <input
                type="text"
                name="passive_name_{{ loop.index0 }}"
                value="{{ passive.name }}"
              />
              <label>Description :</label>
              <textarea name="passive_description_{{ loop.index0 }}">{{ passive.description_raw }}</textarea>
              <label>Tag :</label>
              <input
                type="text"
                name="passive_tag_{{ loop.index0 }}"
                value="{{ passive.tag }}"
              />
              <label>Image :</label>
              <input
                type="text"
                name="passive_image_{{ loop.index0 }}"
                value="{{ passive.image_name }}"
              />
              <div class="checkbox-row">
                <label>
                  <input
                    type="checkbox"
                    name="passive_principal_{{ loop.index0 }}"
                    {%
                    if
                    passive.principal
                    %}checked{%
                    endif
                    %}
                  />
                  Principal
                </label>
                <label>
                  <input
                    type="checkbox"
                    name="passive_hidden_{{ loop.index0 }}"
                    {%
                    if
                    passive.hidden
                    %}checked{%
                    endif
                    %}
                  />
                  Caché
                </label>
              </div>
              <input type="hidden" name="passive_id_{{ loop.index0 }}" value="{{ passive.id }}">
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
          </div>
          {% endif %} {% endfor %}
        </div>
        <button type="button" id="add-passive-btn" class="add-btn">+ Ajouter un passif</button>
      </div>
      <!-- Onglet Compétences -->
      <div class="edit-tab-content" id="edit-tab-skills">
        <div class="skills-grid" id="skills-grid">
          {% for skill in character.skills %} {% if loop.index0 % 2 == 0 %}
          <div class="skills-row">
            {% endif %}
            <div class="edit-skill-block">
              <label>Nom de la compétence :</label>
              <input
                type="text"
                name="skill_name_{{ loop.index0 }}"
                value="{{ skill.name }}"
              />
              <label>Description :</label>
              <textarea name="skill_description_{{ loop.index0 }}">
{{ skill.description_raw }}</textarea
              >
              <label>Tag :</label>
              <input
                type="text"
                name="skill_tag_{{ loop.index0 }}"
                value="{{ skill.tag }}"
              />
              <label>Image :</label>
              <input
                type="text"
                name="skill_image_{{ loop.index0 }}"
                value="{{ skill.image_name }}"
              />
              <div class="checkbox-row">
                <label>
                  <input
                    type="checkbox"
                    name="skill_principal_{{ loop.index0 }}"
                    {%
                    if
                    skill.principal
                    %}checked{%
                    endif
                    %}
                  />
                  Principal
                </label>
              </div>
              <input type="hidden" name="skill_id_{{ loop.index0 }}" value="{{ skill.id }}">
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
          </div>
          {% endif %} {% endfor %}
        </div>
        <button type="button" id="add-skill-btn" class="add-btn">+ Ajouter une compétence</button>
      </div>
      <!-- Onglet Armes -->
      <div class="edit-tab-content" id="edit-tab-weapons">
        {% set total_weapons = character.weapon|length if character.weapon|length > 0 else 1 %}
        {% for weapon_idx in range(total_weapons) %}
          {% set weapon = character.weapon[weapon_idx] if character.weapon|length > weapon_idx else {} %}
          <div class="edit-weapon-block">
            <label>Nom de l'arme :</label>
            <input
              type="text"
              name="weapon_name_{{ weapon_idx }}"
              value="{{ weapon.name if weapon.name is defined else '' }}"
            />
            <label>Stats :</label>
            <textarea name="weapon_stats_{{ weapon_idx }}">{{ weapon.stats_raw if weapon.stats_raw is defined else '' }}</textarea>
            <label>Tag :</label>
            <input
              type="text"
              name="weapon_tag_{{ weapon_idx }}"
              value="{{ weapon.tag if weapon.tag is defined else '' }}"
            />
            <label>Image :</label>
            <input
              type="text"
              name="weapon_image_{{ weapon_idx }}"
              value="{{ weapon.image_name if weapon.image_name is defined else '' }}"
            />
            <label>Principal :</label>
            <input
              type="checkbox"
              name="weapon_principal_{{ weapon_idx }}"
              {% if weapon.principal is defined and weapon.principal %}checked{% endif %}
            />
            <input type="hidden" name="weapon_id_{{ weapon_idx }}" value="{{ weapon.id if weapon.id is defined else '' }}">
            <!-- Toujours 7 évolutions, même si aucune n'est renseignée -->
            {% set total_evos = 7 %}
            <h4 style="margin-top: 18px">Évolutions de l'arme</h4>
            <div class="evolutions-grid">
              {% for i in range(total_evos) %}
                {% if i % 2 == 0 %}
                <div class="evolutions-row">
                {% endif %}
                  <div class="edit-weapon-evolution-block">
                    <label>Évolution : {{ 'A' ~ i if not i == 6 else 'A6-A10' }}</label>
                    <textarea
                      name="weapon_evolution_description_{{ weapon_idx }}_{{ i }}"
                    >{{ weapon.evolutions[i].description_raw if weapon.evolutions is defined and weapon.evolutions|length > i else '' }}</textarea>

              <input type="hidden" name="weapon_evolutions_{{ weapon_idx }}_{{ i }}_evolution_id" value="{{ weapon.evolutions[i].evolution_id }}">
              <input type="hidden" name="weapon_evolutions_id_{{ weapon_idx }}_{{ i }}" value="{{ weapon.evolutions[i].id }}">
                  </div>
                {% if i % 2 == 1 or i == total_evos - 1 %}
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <hr />
        {% endfor %}
      </div>
      <!-- Onglet Artefacts avec sélecteur de set -->
      <div class="edit-tab-content" id="edit-tab-artefacts">
        <div style="display: flex; align-items: center; gap: 12px">
          <label for="edit-equipment-select">Sélectionner le set :</label>
          <select id="edit-equipment-select">
            {% for set in character.equipment_sets %}
              <option value="{{ loop.index0 }}" data-order="{{ set.order if set.order is defined else loop.index0 }}">{{ set.set_name }}</option>
            {% endfor %}
            <option value="add_new_set" style="color: #ff6600">
              + Ajouter un nouveau set
            </option>
          </select>
        </div>
        <div id="edit-artefacts-fields">
          {% for eqSet in character.equipment_sets %}
  {% set set_idx = loop.index0 %}
  <div class="edit-eqset-block" id="eqset-block-{{ set_idx }}" style="display: {{ 'block' if set_idx == 0 else 'none' }};">
    <h4>Set : {{ eqSet.set_name }}</h4>
    <input type="hidden" name="eqset_name_{{ set_idx }}" value="{{ eqSet.set_name }}">
    <label>Description :</label>
    <textarea name="eqset_description_{{ set_idx }}">{{ eqSet.description_raw or eqSet.description }}</textarea>
    <label>Stats à focus :</label>
    <input type="text" name="eqset_focus_stats_{{ set_idx }}" value="{{ eqSet.focus_stats|join(', ') if eqSet.focus_stats else '' }}">
    <input type="hidden" name="eqset_id_{{ set_idx }}" value="{{ eqSet.id }}">
    <input type="hidden" name="eqset_order_{{ set_idx }}" value="{{ eqSet.order if eqSet.order is defined else set_idx }}">
    <h4>Artefacts du set</h4>
    <div class="artefacts-row" style="display: flex;">
      <div class="artefacts-col" style="flex: 1;">
        {% for a_idx in range(4) %}
          {% set artefact = eqSet.artefacts[a_idx] if eqSet.artefacts|length > a_idx else {} %}
          <div class="edit-artefact-block">
            <label>{{ artefact.name if artefact.name is defined else '' }}</label>
            <label>Pannoplie :</label>
            <input type="text" name="artefact_set_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.set if artefact.set is defined else '' }}">
            <label>Image :</label>
            <input type="text" name="artefact_image_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.image_name if artefact.image_name is defined else '' }}">
            <label>Stat principale :</label>
            <input type="text" name="artefact_main_stat_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.main_stat if artefact.main_stat is defined else '' }}">
            <label>Stats secondaires :</label>
            <input type="text" name="artefact_secondary_stats_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.secondary_stats|join(', ') if artefact.secondary_stats is defined else '' }}">
            <input type="hidden" name="artefact_id_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.id if artefact.id is defined else '' }}">
          </div>
        {% endfor %}
      </div>
      <div class="artefacts-col" style="flex: 1;">
        {% for a_idx in range(4, 8) %}
          {% set artefact = eqSet.artefacts[a_idx] if eqSet.artefacts|length > a_idx else {} %}
          <div class="edit-artefact-block">
            <label>{{ artefact.name if artefact.name is defined else '' }}</label>
            <label>Pannoplie :</label>
            <input type="text" name="artefact_set_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.set if artefact.set is defined else '' }}">
            <label>Image :</label>
            <input type="text" name="artefact_image_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.image_name if artefact.image_name is defined else '' }}">
            <label>Stat principale :</label>
            <input type="text" name="artefact_main_stat_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.main_stat if artefact.main_stat is defined else '' }}">
            <label>Stats secondaires :</label>
            <input type="text" name="artefact_secondary_stats_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.secondary_stats|join(', ') if artefact.secondary_stats is defined else '' }}">
            <input type="hidden" name="artefact_id_{{ set_idx }}_{{ a_idx }}" value="{{ artefact.id if artefact.id is defined else '' }}">
          </div>
        {% endfor %}
      </div>
    </div>
    <hr>
    <h4>Noyaux du set</h4>
    {% for c_idx in range(3) %}
      {% set core = eqSet.cores[c_idx] if eqSet.cores|length > c_idx else {} %}
      <div class="edit-core-block">
        <label>Nom du noyau :</label>
        <input type="text" name="core_name_{{ set_idx }}_{{ c_idx }}" value="{{ core.name if core.name is defined else '' }}">
        <label>Image :</label>
        <input type="text" name="core_image_{{ set_idx }}_{{ c_idx }}" value="{{ core.image_name if core.image_name is defined else '' }}">
        <label>Stat principale :</label>
        <input type="text" name="core_main_stat_{{ set_idx }}_{{ c_idx }}" value="{{ core.main_stat if core.main_stat is defined else '' }}">
        <label>Stat secondaire :</label>
        <input type="text" name="core_secondary_stat_{{ set_idx }}_{{ c_idx }}" value="{{ core.secondary_stat if core.secondary_stat is defined else '' }}">
        <input type="hidden" name="core_id_{{ set_idx }}_{{ c_idx }}" value="{{ core.id if core.id is defined else '' }}">
      </div>
      <hr>
    {% endfor %}
  </div>
{% endfor %}
        </div>
      </div>
      <div
        style="display: flex; justify-content: space-between; margin-top: 18px"
      >
        <button type="submit" class="admin-btn">Enregistrer</button>
        <button
          type="button"
          id="close-edit-character"
          class="close-btn"
          style="font-size: 22px"
        >
          &times;
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  // Gestion des onglets
  document.querySelectorAll('.edit-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.edit-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.edit-tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('edit-tab-' + tab.dataset.tab).classList.add('active');
    });
  });

  // Sélecteur pour afficher le bon bloc de set à modifier dans l'onglet artefacts
  document.getElementById('edit-equipment-select')?.addEventListener('change', function(e) {
    const idx = this.value;
    document.querySelectorAll('.edit-eqset-block').forEach((block, i) => {
      block.style.display = (i == idx) ? 'block' : 'none';
    });
  });

  // Onglet actif par défaut (infos principales)
  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll(".edit-tab");
    const tabContents = document.querySelectorAll(".edit-tab-content");
    tabs.forEach((tab, idx) => {
      if (tab.classList.contains("active")) {
        tabContents[idx].classList.add("active");
      } else {
        tabContents[idx].classList.remove("active");
      }
    });
    // Gestion du clic sur les onglets
    tabs.forEach((tab, idx) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tabContents.forEach((tc) => tc.classList.remove("active"));
        tab.classList.add("active");
        tabContents[idx].classList.add("active");
      });
    });
  });

  // Sauvegarde l'état initial du formulaire à l'ouverture
  let initialFormData = null;
  const form = document.getElementById('edit-character-form');
  if (form) {
    function serializeForm(form) {
      const formData = new FormData(form);
      return Array.from(formData.entries()).sort();
    }
    document.getElementById('edit-character-btn')?.addEventListener('click', () => {
      initialFormData = serializeForm(form);
    });
    form.addEventListener('submit', function(e) {
      // Remplace tous les "None" ou null par ""
      Array.from(form.elements).forEach(el => {
        if (el.value === "None") {
          el.value = null;
        }
      });
      const currentFormData = serializeForm(form);
      if (initialFormData && JSON.stringify(initialFormData) === JSON.stringify(currentFormData)) {
        e.preventDefault();
        alert("Aucune modification détectée.");
        return false;
      }
    });
  }

  // Fermeture de la modale si clic en dehors du popup
  const overlay = document.getElementById('edit-character-overlay');
  const popup = document.getElementById('edit-character-menu');
  if (overlay && popup) {
    overlay.addEventListener('mousedown', function(e) {
      if (e.target === overlay) {
        overlay.style.display = 'none';
      }
    });
  }

  // Permet de déclencher l'ajout même si "add_new_set" est déjà sélectionné
  const select = document.getElementById('edit-equipment-select');
  if (select) {
    select.addEventListener('click', function(e) {
      if (select.value === "add_new_set") {
        const event = new Event('change');
        select.dispatchEvent(event);
      }
    });
  }

  // Ajout d'un passif
  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById('add-passive-btn')?.addEventListener('click', function() {
      const grid = document.getElementById('passives-grid');
      const index = grid.querySelectorAll('.edit-passive-block').length;
      const row = document.createElement('div');
      row.className = 'passives-row';
      row.innerHTML = `
        <div class="edit-passive-block">
          <label>Nom du passif :</label>
          <input type="text" name="passive_name_${index}" value="" />
          <label>Description :</label>
          <textarea name="passive_description_${index}"></textarea>
          <label>Tag :</label>
          <input type="text" name="passive_tag_${index}" value="" />
          <label>Image :</label>
          <input type="text" name="passive_image_${index}" value="" />
          <div class="checkbox-row">
            <label>
              <input type="checkbox" name="passive_principal_${index}" /> Principal
            </label>
            <label>
              <input type="checkbox" name="passive_hidden_${index}" /> Caché
            </label>
          </div>
        </div>
      `;
      grid.appendChild(row);
    });

    // Ajout d'une compétence
    document.getElementById('add-skill-btn')?.addEventListener('click', function() {
      const grid = document.getElementById('skills-grid');
      const index = grid.querySelectorAll('.edit-skill-block').length;
      const row = document.createElement('div');
      row.className = 'skills-row';
      row.innerHTML = `
        <div class="edit-skill-block">
          <label>Nom de la compétence :</label>
          <input type="text" name="skill_name_${index}" value="" />
          <label>Description :</label>
          <textarea name="skill_description_${index}"></textarea>
          <label>Tag :</label>
          <input type="text" name="skill_tag_${index}" value="" />
          <label>Image :</label>
          <input type="text" name="skill_image_${index}" value="" />
          <div class="checkbox-row">
            <label>
              <input type="checkbox" name="skill_principal_${index}" /> Principal
            </label>
          </div>
        </div>
      `;
      grid.appendChild(row);
    });
  });

  // Ajout d'un set d'équipement
  document.getElementById('edit-equipment-select')?.addEventListener('change', function(e) {
    if (this.value === "add_new_set") {
      const setName = prompt("Nom du nouveau set :");
      if (!setName) {
        this.value = 0;
        return;
      }
      const setOrder = prompt("Ordre d'affichage du set (nombre, optionnel) :") || "";

      // Trouver le plus grand index déjà utilisé
      const usedIndexes = Array.from(document.querySelectorAll('input[name^="eqset_name_"]'))
        .map(input => Number(input.name.match(/eqset_name_(\d+)/)[1]));
      const setIdx = usedIndexes.length ? Math.max(...usedIndexes) + 1 : 0;

      // Création de la nouvelle option
      const option = document.createElement('option');
      option.value = setIdx;
      option.textContent = setName;
      option.dataset.order = setOrder;

      // Insérer l'option à la bonne place selon l'ordre
      let inserted = false;
      const select = this;
      const addNewSetOption = select.querySelector('option[value="add_new_set"]');
      const options = Array.from(select.options).filter(opt => opt !== addNewSetOption);

      const setOrderNum = setOrder !== "" ? Number(setOrder) : Number.MAX_SAFE_INTEGER;
      let insertPos = options.length;
      for (let i = 0; i < options.length; i++) {
        const optOrder = options[i].dataset.order !== undefined && options[i].dataset.order !== ""
          ? Number(options[i].dataset.order)
          : Number.MAX_SAFE_INTEGER;
        if (setOrderNum < optOrder) {
          select.insertBefore(option, options[i]);
          insertPos = i;
          inserted = true;
          break;
        }
      }
      if (!inserted) {
        select.insertBefore(option, addNewSetOption);
        insertPos = options.length;
      }
      select.value = setIdx;

      // Crée le bloc HTML du nouveau set
      const fields = document.getElementById('edit-artefacts-fields');
      const div = document.createElement('div');
      div.className = 'edit-eqset-block';
      div.id = `eqset-block-${setIdx}`;
      div.style.display = 'block';
      document.querySelectorAll('.edit-eqset-block').forEach(b => b.style.display = 'none');
      div.innerHTML = `
        <h4>Set : ${setName}</h4>
        <input type="hidden" name="eqset_name_${setIdx}" value="${setName}">
        <input type="hidden" name="eqset_id_${setIdx}" value="">
        <label>Description :</label>
        <textarea name="eqset_description_${setIdx}"></textarea>
        <label>Stats à focus :</label>
        <input type="text" name="eqset_focus_stats_${setIdx}" value="">
        <input type="hidden" name="eqset_order_${setIdx}" value="${setOrder}">
        <h4>Artefacts du set</h4>
        <div class="artefacts-row" style="display: flex;">
          <div class="artefacts-col" style="flex: 1;">
            ${[0,1,2,3].map(a_idx => `
              <div class="edit-artefact-block">
                <label></label>
                <label>Pannoplie :</label>
                <input type="text" name="artefact_set_${setIdx}_${a_idx}" value="">
                <label>Image :</label>
                <input type="text" name="artefact_image_${setIdx}_${a_idx}" value="">
                <label>Stat principale :</label>
                <input type="text" name="artefact_main_stat_${setIdx}_${a_idx}" value="">
                <label>Stats secondaires :</label>
                <input type="text" name="artefact_secondary_stats_${setIdx}_${a_idx}" value="">
                <input type="hidden" name="artefact_id_${setIdx}_${a_idx}" value="">
              </div>
            `).join('')}
          </div>
          <div class="artefacts-col" style="flex: 1;">
            ${[4,5,6,7].map(a_idx => `
              <div class="edit-artefact-block">
                <label></label>
                <label>Pannoplie :</label>
                <input type="text" name="artefact_set_${setIdx}_${a_idx}" value="">
                <label>Image :</label>
                <input type="text" name="artefact_image_${setIdx}_${a_idx}" value="">
                <label>Stat principale :</label>
                <input type="text" name="artefact_main_stat_${setIdx}_${a_idx}" value="">
                <label>Stats secondaires :</label>
                <input type="text" name="artefact_secondary_stats_${setIdx}_${a_idx}" value="">
                <input type="hidden" name="artefact_id_${setIdx}_${a_idx}" value="">
              </div>
            `).join('')}
          </div>
        </div>
        <hr>
        <h4>Noyaux du set</h4>
        ${[0,1,2].map(c_idx => `
          <div class="edit-core-block">
            <label>Nom du noyau :</label>
            <input type="text" name="core_name_${setIdx}_${c_idx}" value="">
            <label>Image :</label>
            <input type="text" name="core_image_${setIdx}_${c_idx}" value="">
            <label>Stat principale :</label>
            <input type="text" name="core_main_stat_${setIdx}_${c_idx}" value="">
            <label>Stat secondaire :</label>
            <input type="text" name="core_secondary_stat_${setIdx}_${c_idx}" value="">
            <input type="hidden" name="core_id_${setIdx}_${c_idx}" value="">
          </div>
          <hr>
        `).join('')}
      `;
      fields.appendChild(div);
    }
  });
</script>
