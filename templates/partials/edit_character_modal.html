<div
  id="edit-character-overlay"
  class="edit-character-overlay"
  style="display: none"
>
  <div id="edit-character-menu" class="edit-character-popup">
    <form
      id="edit-character-form"
      method="POST"
      action="{{ url_for('edit_character', char_id=character.id) }}"
    >
      <h2 style="text-align: center; color: #ffcc00">Modifier le personnage</h2>
      <div class="edit-tabs">
        <div class="edit-tab active" data-tab="main">Infos principales</div>
        <div class="edit-tab" data-tab="passives">Passifs</div>
        <div class="edit-tab" data-tab="skills">Compétences</div>
        <div class="edit-tab" data-tab="weapons">Armes</div>
        <div class="edit-tab" data-tab="artefacts">Artefacts</div>
      </div>
      <!-- Onglet Infos principales -->
      <div class="edit-tab-content active" id="edit-tab-main">
        <label>Nom :</label>
        <input type="text" name="name" value="{{ character.name }}" required />
        <label>Alias :</label>
        <input
          type="text"
          name="alias"
          value="{{ character.alias }}"
          required
        />
        <label>Type :</label>
        <input type="text" name="type" value="{{ character.type }}" required />
        <label>Rareté :</label>
        <input
          type="text"
          name="rarity"
          value="{{ character.rarity }}"
          required
        />
        <label>Description :</label>
        <textarea name="description" required>
{{ character.description }}</textarea
        >
        <label>Image :</label>
        <input type="text" name="image" value="{{ character.image_name }}" />

        <h4 style="margin-top: 28px">Évolutions du personnage</h4>
        <div class="evolutions-grid">
          {% set total_evos = 7 %} {% for i in range(total_evos) %} {% if i % 2
          == 0 %}
          <div class="evolutions-row">
            {% endif %}
            <div class="edit-evolution-block">
              <label>Évolution : {{ 'A' ~ i if not i == 6 else 'A6-A10' }}</label>
              <textarea name="evolution_description_{{ i }}">
{{ character.evolutions[i].description_raw if character.evolutions|length > i else '' }}</textarea
              >
            </div>
            {% if i % 2 == 1 or i == total_evos - 1 %}
          </div>
          {% endif %} {% endfor %}
        </div>
      </div>
      <!-- Onglet Passifs -->
      <div class="edit-tab-content" id="edit-tab-passives">
        <div class="passives-grid">
          {% for passive in character.passives_all %} {% if loop.index0 % 2 == 0
          %}
          <div class="passives-row">
            {% endif %}
            <!-- Exemple pour un passif, à appliquer aussi pour skills, weapons, etc. -->
            <div class="edit-passive-block">
              <label>Nom du passif :</label>
              <input
                type="text"
                name="passive_name_{{ loop.index0 }}"
                value="{{ passive.name }}"
              />
              <label>Description :</label>
              <textarea name="passive_description_{{ loop.index0 }}">
{{ passive.description_raw }}</textarea
              >
              <label>Tag :</label>
              <input
                type="text"
                name="passive_tag_{{ loop.index0 }}"
                value="{{ passive.tag }}"
              />
              <label>Image :</label>
              <input
                type="text"
                name="passive_image_{{ loop.index0 }}"
                value="{{ passive.image_name }}"
              />
              <div class="checkbox-row">
                <label>
                  <input
                    type="checkbox"
                    name="passive_principal_{{ loop.index0 }}"
                    {%
                    if
                    passive.principal
                    %}checked{%
                    endif
                    %}
                  />
                  Principal
                </label>
                <label>
                  <input
                    type="checkbox"
                    name="passive_hidden_{{ loop.index0 }}"
                    {%
                    if
                    passive.hidden
                    %}checked{%
                    endif
                    %}
                  />
                  Caché
                </label>
              </div>
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
          </div>
          {% endif %} {% endfor %}
        </div>
      </div>
      <!-- Onglet Compétences -->
      <div class="edit-tab-content" id="edit-tab-skills">
        <div class="skills-grid">
          {% for skill in character.skills %} {% if loop.index0 % 2 == 0 %}
          <div class="skills-row">
            {% endif %}
            <div class="edit-skill-block">
              <label>Nom de la compétence :</label>
              <input
                type="text"
                name="skill_name_{{ loop.index0 }}"
                value="{{ skill.name }}"
              />
              <label>Description :</label>
              <textarea name="skill_description_{{ loop.index0 }}">
{{ skill.description_raw }}</textarea
              >
              <label>Tag :</label>
              <input
                type="text"
                name="skill_tag_{{ loop.index0 }}"
                value="{{ skill.tag }}"
              />
              <label>Image :</label>
              <input
                type="text"
                name="skill_image_{{ loop.index0 }}"
                value="{{ skill.image_name }}"
              />
              <div class="checkbox-row">
                <label>
                  <input
                    type="checkbox"
                    name="skill_principal_{{ loop.index0 }}"
                    {%
                    if
                    skill.principal
                    %}checked{%
                    endif
                    %}
                  />
                  Principal
                </label>
              </div>
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
          </div>
          {% endif %} {% endfor %}
        </div>
      </div>
      <!-- Onglet Armes -->
      <div class="edit-tab-content" id="edit-tab-weapons">
        {% for weapon in character.weapon %}
          {% set weapon_idx = loop.index0 %}
        <div class="edit-weapon-block">
          <label>Nom de l'arme :</label>
          <input
            type="text"
            name="weapon_name_{{ weapon_idx }}"
            value="{{ weapon.name }}"
          />
          <label>Stats :</label>
          <textarea name="weapon_stats_{{ weapon_idx }}">
{{ weapon.stats_raw }}</textarea
          >
          <label>Tag :</label>
          <input
            type="text"
            name="weapon_tag_{{ weapon_idx }}"
            value="{{ weapon.tag }}"
          />
          <label>Image :</label>
          <input
            type="text"
            name="weapon_image_{{ weapon_idx }}"
            value="{{ weapon.image_name }}"
          />
          <label>Principal :</label>
          <input
            type="checkbox"
            name="weapon_principal_{{ weapon_idx }}"
            {%
            if
            weapon.principal
            %}checked{%
            endif
            %}
          />
          <!-- Toujours 7 évolutions, même si aucune n'est renseignée -->
          {% set total_evos = 7 %}
          <h4 style="margin-top: 18px">Évolutions de l'arme</h4>
          <div class="evolutions-grid">
            {% for i in range(total_evos) %}
              {% if i % 2 == 0 %}
              <div class="evolutions-row">
              {% endif %}
                <div class="edit-weapon-evolution-block">
                  <label>Évolution : {{ 'A' ~ i if not i == 6 else 'A6-A10' }}</label>
                  <textarea
                    name="weapon_evolution_description_{{ weapon_idx }}_{{ i }}"
                  >{{ weapon.evolutions[i].description_raw if weapon.evolutions|length > i else '' }}</textarea
                  >
                </div>
              {% if i % 2 == 1 or i == total_evos - 1 %}
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <hr />
        {% endfor %}
      </div>
      <!-- Onglet Artefacts avec sélecteur de set -->
      <div class="edit-tab-content" id="edit-tab-artefacts">
        <div style="display: flex; align-items: center; gap: 12px">
          <label for="edit-equipment-select">Sélectionner le set :</label>
          <select id="edit-equipment-select">
            {% for set in character.equipment_sets %}
            <option value="{{ loop.index0 }}">{{ set.set_name }}</option>
            {% endfor %}
            <option value="add_new_set" style="color: #ff6600">
              + Ajouter un nouveau set
            </option>
          </select>
        </div>
        <div id="edit-artefacts-fields">
          <!-- Les champs du set sélectionné seront injectés ici en JS -->
        </div>
      </div>
      <div
        style="display: flex; justify-content: space-between; margin-top: 18px"
      >
        <button type="submit" class="admin-btn">Enregistrer</button>
        <button
          type="button"
          id="close-edit-character"
          class="close-btn"
          style="font-size: 22px"
        >
          &times;
        </button>
      </div>
    </form>
  </div>
</div>
<script>
      document.querySelectorAll('.edit-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.edit-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.edit-tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('edit-tab-' + tab.dataset.tab).classList.add('active');
        });
      });
      // Sélecteur pour afficher le bon bloc de set à modifier dans l'onglet artefacts
      document.getElementById('edit-equipment-select')?.addEventListener('change', function(e) {
        const idx = e.target.value;
        document.querySelectorAll('.edit-eqset-block').forEach((block, i) => {
          block.style.display = (i == idx) ? 'block' : 'none';
        });
      });
      document.addEventListener("DOMContentLoaded", function() {
        const equipmentSets = {{ character.equipment_sets|tojson }};
        const select = document.getElementById('edit-equipment-select');
        const fieldsContainer = document.getElementById('edit-artefacts-fields');
        // Récupère la langue depuis une variable globale ou un attribut data-lang sur le body
  const language = "{{ language }}".toLowerCase(); // Flask/Jinja2 injecte la langue ici

  // Définition dynamique de l'ordre des artefacts selon la langue
  const artefactOrder = (language === "fr-fr")
    ? [
        { keys: ['Casque'], col: 'left' },
        { keys: ['Plastron'], col: 'left' },
        { keys: ['Gants'], col: 'left' },
        { keys: ['Bottes'], col: 'left' },
        { keys: ['Collier'], col: 'right' },
        { keys: ['Bracelet'], col: 'right' },
        { keys: ['Bague'], col: 'right' },
        { keys: ['Boucle d\'oreille'], col: 'right' }
      ]
    : [
        { keys: ['Helmet'], col: 'left' },
        { keys: ['Chestplate'], col: 'left' },
        { keys: ['Gloves'], col: 'left' },
        { keys: ['Boots'], col: 'left' },
        { keys: ['Necklace'], col: 'right' },
        { keys: ['Bracelet'], col: 'right' },
        { keys: ['Ring'], col: 'right' },
        { keys: ['Earring'], col: 'right' }
      ];
        function renderArtefactFields(setIndex) {
          const eqSet = equipmentSets[setIndex];
          let html = `
            <h4>Set : ${eqSet.set_name}</h4>
            <label>Description :</label>
            <textarea name="eqset_description_${setIndex}">${eqSet.description_raw || eqSet.description || ''}</textarea>
            <label>Stats à focus :</label>
            <input type="text" name="eqset_focus_stats_${setIndex}" value="${eqSet.focus_stats ? eqSet.focus_stats.join(', ') : ''}">
            <h4>Artefacts du set</h4>
            <div class="artefacts-row">
              <div class="artefacts-col">
          `;

          // Indexation des artefacts par nom pour accès rapide
          const artefactsByName = {};
          eqSet.artefacts.forEach(a => {
            artefactsByName[a.name.toLowerCase()] = a;
          });

          // Colonne gauche : pièces d’armure
          ['Helmet', 'Casque', 'Chestplate', 'Plastron', 'Gloves', 'Gants', 'Boots', 'Bottes'].forEach((type, idx) => {
            if (idx === 4) html += `</div><div class="artefacts-col">`; // Passe à la colonne bijoux après 4 éléments
            // Trouve l’artefact correspondant
            let artefact = null;
            for (const key of artefactOrder[idx].keys) {
              artefact = eqSet.artefacts.find(a => a.name && a.name.toLowerCase() === key.toLowerCase());
              if (artefact) break;
            }
            // Si non trouvé, crée un artefact vide
            if (!artefact) {
              artefact = {
                name: artefactOrder[idx].keys[0],
                set: eqSet.set_name,
                image_name: '',
                main_stat: '',
                secondary_stats: [],
                description_raw: ''
              };
            }
            html += `
              <div class="edit-artefact-block">
                <label>${artefact.name}</label>
                <label>Pannoplie :</label>
                <input type="text" name="artefact_set_${setIndex}_${idx}" value="${artefact.set || ''}">
                <label>Image :</label>
                <input type="text" name="artefact_image_${setIndex}_${idx}" value="${artefact.image_name || ''}">
                <label>Stat principale :</label>
                <input type="text" name="artefact_main_stat_${setIndex}_${idx}" value="${artefact.main_stat || ''}">
                <label>Stats secondaires :</label>
                <input type="text" name="artefact_secondary_stats_${setIndex}_${idx}" value="${(artefact.secondary_stats || []).join(', ')}">
              </div>
            `;
          });

          html += `</div></div><hr><h4>Noyaux du set</h4>`;

          const coreOrder = ['01', '02', '03'];
          let coresByNumber = {};
          if (eqSet.cores) {
            eqSet.cores.forEach(core => {
              if (core.number) coresByNumber[core.number] = core;
            });
          }
          for (let i = 0; i < 3; i++) {
            const num = coreOrder[i];
            const core = coresByNumber[num] || { name: '', number: num, image_name: '', main_stat: '', secondary_stat: '' };
            html += `
              <div class="edit-core-block">
                <label>Nom du noyau :</label>
                <input type="text" name="core_name_${setIndex}_${i}" value="${core.name}">
                <label>Image :</label>
                <input type="text" name="core_image_${setIndex}_${i}" value="${core.image_name}">
                <label>Stat principale :</label>
                <input type="text" name="core_main_stat_${setIndex}_${i}" value="${core.main_stat}">
                <label>Stat secondaire :</label>
                <input type="text" name="core_secondary_stat_${setIndex}_${i}" value="${core.secondary_stat}">
              </div>
              <hr>
            `;
          }

          fieldsContainer.innerHTML = html;
        }

        // Affiche le premier set au chargement
        renderArtefactFields(select.value);

        // Change les champs quand on change de set
        select.addEventListener('change', function() {
          if (this.value === "add_new_set") {
            let setName = prompt("Nom du nouveau set :");
            if (!setName) {
              // Si aucun set n'existe, on vide tout
              if (equipmentSets.length === 0) {
                select.selectedIndex = 0;
                fieldsContainer.innerHTML = "";
              } else {
                select.value = 0;
                renderArtefactFields(select.value);
              }
              return;
            }

            let maxPos = equipmentSets.length;
            let pos = prompt(`À quelle position insérer le set ? (1 = début, ${maxPos + 1} = fin)`, maxPos + 1);
            pos = parseInt(pos, 10);
            if (isNaN(pos) || pos < 1 || pos > maxPos + 1) pos = maxPos + 1;

            const emptySet = {
              set_name: setName,
              description: '',
              description_raw: '',
              focus_stats: [],
              artefacts: artefactOrder.map(order => ({
                name: order.keys[0],
                set: '',
                image_name: '',
                main_stat: '',
                secondary_stats: [],
                description_raw: ''
              })),
              cores: [
                { name: '', number: '01', image_name: '', main_stat: '', secondary_stat: '' },
                { name: '', number: '02', image_name: '', main_stat: '', secondary_stat: '' },
                { name: '', number: '03', image_name: '', main_stat: '', secondary_stat: '' }
              ]
            };

            equipmentSets.splice(pos - 1, 0, emptySet);

            // Reconstruit le select (toujours, même si vide avant)
            while (select.options.length > 0) select.remove(0);
            equipmentSets.forEach((set, i) => {
              const option = document.createElement('option');
              option.value = i;
              option.textContent = set.set_name;
              select.appendChild(option);
            });
            const addOption = document.createElement('option');
            addOption.value = "add_new_set";
            addOption.textContent = "+ Ajouter un nouveau set";
            addOption.style.color = "#ff6600";
            select.appendChild(addOption);

            // Sélectionne et affiche le nouveau set
            select.value = pos - 1;
            renderArtefactFields(select.value);
          } else if (equipmentSets.length > 0) {
            renderArtefactFields(this.value);
          } else {
            fieldsContainer.innerHTML = "";
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const tabs = document.querySelectorAll(".edit-tab");
        const tabContents = document.querySelectorAll(".edit-tab-content");

        // Onglet actif par défaut (infos principales)
        tabs.forEach((tab, idx) => {
          if (tab.classList.contains("active")) {
            tabContents[idx].classList.add("active");
          } else {
            tabContents[idx].classList.remove("active");
          }
        });

        // Gestion du clic sur les onglets
        tabs.forEach((tab, idx) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tabContents.forEach((tc) => tc.classList.remove("active"));
            tab.classList.add("active");
            tabContents[idx].classList.add("active");
          });
        });
      });

  // Sauvegarde l'état initial du formulaire à l'ouverture
  let initialFormData = null;
  const form = document.getElementById('edit-character-form');
  if (form) {
    // Fonction pour sérialiser tous les champs du formulaire
    function serializeForm(form) {
      const formData = new FormData(form);
      // On convertit en tableau clé=valeur pour comparaison simple
      return Array.from(formData.entries()).sort();
    }

    // À l'ouverture de la modale, on sauvegarde l'état initial
    document.getElementById('edit-character-btn')?.addEventListener('click', () => {
      initialFormData = serializeForm(form);
    });

    // Avant soumission, on vérifie si quelque chose a changé
    form.addEventListener('submit', function(e) {
      const currentFormData = serializeForm(form);
      // Compare les deux tableaux (JSON.stringify suffit ici car trié)
      if (initialFormData && JSON.stringify(initialFormData) === JSON.stringify(currentFormData)) {
        e.preventDefault();
        alert("Aucune modification détectée.");
        return false;
      }
      // Sinon, la soumission continue normalement
    });
  }

  const overlay = document.getElementById('edit-character-overlay');
  const popup = document.getElementById('edit-character-menu');

  if (overlay && popup) {
    overlay.addEventListener('mousedown', function(e) {
      // Si le clic est sur l'overlay mais pas dans le popup
      if (e.target === overlay) {
        overlay.style.display = 'none';
      }
    });
  }
</script>
