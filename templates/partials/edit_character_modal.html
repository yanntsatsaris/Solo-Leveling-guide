<div
  id="edit-character-overlay"
  class="edit-character-overlay"
  style="display: none"
>
  <div id="edit-character-menu" class="edit-character-popup">
    <form
      id="edit-character-form"
      method="POST"
      action="{{ url_for('edit_character', char_id=character.id) }}"
    >
      <h2 style="text-align: center; color: #ffcc00">Modifier le personnage</h2>
      <div class="edit-tabs">
        <div class="edit-tab active" data-tab="main">Infos principales</div>
        <div class="edit-tab" data-tab="passives">Passifs</div>
        <div class="edit-tab" data-tab="skills">Compétences</div>
        <div class="edit-tab" data-tab="weapons">Armes</div>
        <div class="edit-tab" data-tab="artefacts">Artefacts</div>
      </div>
      <!-- Onglet Infos principales -->
      <div class="edit-tab-content active" id="edit-tab-main">
        <label>Nom :</label>
        <input type="text" name="name" value="{{ character.name }}" required />
        <label>Alias :</label>
        <input
          type="text"
          name="alias"
          value="{{ character.alias }}"
          required
        />
        <label>Type :</label>
        <input type="text" name="type" value="{{ character.type }}" required />
        <label>Rareté :</label>
        <input
          type="text"
          name="rarity"
          value="{{ character.rarity }}"
          required
        />
        <label>Description :</label>
        <textarea name="description" required>{{ character.description }}</textarea>
        <label>Image :</label>
        <input type="text" name="image" value="{{ character.image_name }}" />

        <h4 style="margin-top:28px;">Évolutions du personnage</h4>
        <div class="evolutions-grid">
          {% for evo in character.evolutions %}
            {% if loop.index0 % 2 == 0 %}
              <div class="evolutions-row">
            {% endif %}
            <div class="edit-evolution-block">
              <label>Évolution : {{ 'A' ~ (loop.index) if not loop.last else 'A6-A10' }}</label>
              <textarea name="evolution_description_{{ loop.index0 }}">{{ evo.description_raw }}</textarea>
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <!-- Onglet Passifs -->
      <div class="edit-tab-content" id="edit-tab-passives">
        <div class="passives-grid">
          {% for passive in character.passives_all %}
            {% if loop.index0 % 2 == 0 %}
              <div class="passives-row">
            {% endif %}
            <!-- Exemple pour un passif, à appliquer aussi pour skills, weapons, etc. -->
            <div class="edit-passive-block">
              <label>Nom du passif :</label>
              <input type="text" name="passive_name_{{ loop.index0 }}" value="{{ passive.name }}" />
              <label>Description :</label>
              <textarea name="passive_description_{{ loop.index0 }}">{{ passive.description_raw }}</textarea>
              <label>Tag :</label>
              <input type="text" name="passive_tag_{{ loop.index0 }}" value="{{ passive.tag }}" />
              <label>Image :</label>
              <input type="text" name="passive_image_{{ loop.index0 }}" value="{{ passive.image_name }}" />
              <div class="checkbox-row">
                <label>
                  <input type="checkbox" name="passive_principal_{{ loop.index0 }}" {% if passive.principal %}checked{% endif %} />
                  Principal
                </label>
                <label>
                  <input type="checkbox" name="passive_hidden_{{ loop.index0 }}" {% if passive.hidden %}checked{% endif %} />
                  Caché
                </label>
              </div>
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <!-- Onglet Compétences -->
      <div class="edit-tab-content" id="edit-tab-skills">
        <div class="skills-grid">
          {% for skill in character.skills %}
            {% if loop.index0 % 2 == 0 %}
              <div class="skills-row">
            {% endif %}
            <div class="edit-skill-block">
              <label>Nom de la compétence :</label>
              <input
                type="text"
                name="skill_name_{{ loop.index0 }}"
                value="{{ skill.name }}"
              />
              <label>Description :</label>
              <textarea name="skill_description_{{ loop.index0 }}">{{ skill.description_raw }}</textarea>
              <label>Tag :</label>
              <input
                type="text"
                name="skill_tag_{{ loop.index0 }}"
                value="{{ skill.tag }}"
              />
              <label>Image :</label>
              <input
                type="text"
                name="skill_image_{{ loop.index0 }}"
                value="{{ skill.image_name }}"
              />
              <div class="checkbox-row">
                <label>
                  <input
                    type="checkbox"
                    name="skill_principal_{{ loop.index0 }}"
                    {% if skill.principal %}checked{% endif %}
                  />
                  Principal
                </label>
              </div>
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <!-- Onglet Armes -->
      <div class="edit-tab-content" id="edit-tab-weapons">
        {% for weapon in character.weapon %}
        <div class="edit-weapon-block">
          <label>Nom de l'arme :</label>
          <input
            type="text"
            name="weapon_name_{{ loop.index0 }}"
            value="{{ weapon.name }}"
          />
          <label>Stats :</label>
          <textarea name="weapon_stats_{{ loop.index0 }}">{{ weapon.stats_raw }}</textarea>
          <label>Tag :</label>
          <input
            type="text"
            name="weapon_tag_{{ loop.index0 }}"
            value="{{ weapon.tag }}"
          />
          <label>Image :</label>
          <input
            type="text"
            name="weapon_image_{{ loop.index0 }}"
            value="{{ weapon.image }}"
          />
          <label>Principal :</label>
          <input
            type="checkbox"
            name="weapon_principal_{{ loop.index0 }}"
            {% if weapon.principal %}checked{% endif %}
          />
          <!-- Évolutions de l'arme en grille 2 par ligne -->
          {% if weapon.evolutions %}
          <h4 style="margin-top:18px;">Évolutions de l'arme</h4>
          <div class="evolutions-grid">
            {% for evo in weapon.evolutions %}
            {% if loop.index0 % 2 == 0 %}
              <div class="evolutions-row">
            {% endif %}
            <div class="edit-weapon-evolution-block">
              <label>Évolution : {{ 'A' ~ (loop.index) if not loop.last else 'A6-A10' }}</label>
              <textarea name="weapon_evolution_description_{{ loop.index0 }}">{{ evo.description_raw }}</textarea>
            </div>
            {% if loop.index0 % 2 == 1 or loop.last %}
              </div>
            {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <hr />
        {% endfor %}
      </div>
      <!-- Onglet Artefacts avec sélecteur de set -->
      <div class="edit-tab-content" id="edit-tab-artefacts">
        <div style="display: flex; align-items: center; gap: 12px">
          <label for="edit-equipment-select">Sélectionner le set :</label>
          <select id="edit-equipment-select">
            {% for set in character.equipment_sets %}
            <option value="{{ loop.index0 }}">{{ set.set_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div id="edit-artefacts-fields">
          <!-- Les champs du set sélectionné seront injectés ici en JS -->
        </div>
      </div>
      <div
        style="display: flex; justify-content: space-between; margin-top: 18px"
      >
        <button type="submit" class="admin-btn">Enregistrer</button>
        <button
          type="button"
          id="close-edit-character"
          class="close-btn"
          style="font-size: 22px"
        >
          &times;
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  document.querySelectorAll('.edit-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.edit-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.edit-tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('edit-tab-' + tab.dataset.tab).classList.add('active');
    });
  });
  // Sélecteur pour afficher le bon bloc de set à modifier dans l'onglet artefacts
  document.getElementById('edit-equipment-select')?.addEventListener('change', function(e) {
    const idx = e.target.value;
    document.querySelectorAll('.edit-eqset-block').forEach((block, i) => {
      block.style.display = (i == idx) ? 'block' : 'none';
    });
  });
  document.addEventListener("DOMContentLoaded", function() {
    const equipmentSets = {{ character.equipment_sets|tojson }};
    const select = document.getElementById('edit-equipment-select');
    const fieldsContainer = document.getElementById('edit-artefacts-fields');

    function renderArtefactFields(setIndex) {
      const eqSet = equipmentSets[setIndex];
      let html = `
        <h4>Set : ${eqSet.set_name}</h4>
        <label>Description :</label>
        <textarea name="eqset_description_${setIndex}">${eqSet.description_raw || eqSet.description}</textarea>
        <label>Stats à focus :</label>
        <input type="text" name="eqset_focus_stats_${setIndex}" value="${eqSet.focus_stats.join(', ')}">
        <h4>Artefacts du set</h4>
        <div class="artefacts-row">
          <div class="artefacts-col">
      `;
      // Colonne de gauche (artefacts 0 à 3)
      eqSet.artefacts.slice(0, 4).forEach((artefact, i) => {
        html += `
          <div class="edit-artefact-block">
            <label>${artefact.name}</label>
            <label>Set :</label>
            <input type="text" name="artefact_set_${setIndex}_${i}" value="${artefact.set}">
            <label>Image :</label>
            <input type="text" name="artefact_image_${setIndex}_${i}" value="${artefact.image_name}">
            <label>Stat principale :</label>
            <input type="text" name="artefact_main_stat_${setIndex}_${i}" value="${artefact.main_stat}">
            <label>Stats secondaires :</label>
            <input type="text" name="artefact_secondary_stats_${setIndex}_${i}" value="${artefact.secondary_stats.join(', ')}">
          </div>
        `;
      });
      html += `
          </div>
          <div class="artefacts-col">
      `;
      // Colonne de droite (artefacts 4 à 7)
      eqSet.artefacts.slice(4, 8).forEach((artefact, i) => {
        html += `
          <div class="edit-artefact-block">
            <label>${artefact.name}</label>
            <label>Set :</label>
            <input type="text" name="artefact_set_${setIndex}_${i+4}" value="${artefact.set}">
            <label>Image :</label>
            <input type="text" name="artefact_image_${setIndex}_${i+4}" value="${artefact.image_name}">
            <label>Stat principale :</label>
            <input type="text" name="artefact_main_stat_${setIndex}_${i+4}" value="${artefact.main_stat}">
            <label>Stats secondaires :</label>
            <input type="text" name="artefact_secondary_stats_${setIndex}_${i+4}" value="${artefact.secondary_stats.join(', ')}">
          </div>
        `;
      });
      html += `
          </div>
        </div>
        <hr>
        <h4>Noyaux du set</h4>
      `;
      eqSet.cores.forEach((core, i) => {
        html += `
          <div class="edit-core-block">
            <label>Nom du noyau :</label>
            <input type="text" name="core_name_${setIndex}_${i}" value="${core.name}">
            <label>Numéro :</label>
            <input type="text" name="core_number_${setIndex}_${i}" value="${core.number}">
            <label>Image :</label>
            <input type="text" name="core_image_${setIndex}_${i}" value="${core.image_name}">
            <label>Stat principale :</label>
            <input type="text" name="core_main_stat_${setIndex}_${i}" value="${core.main_stat}">
            <label>Stat secondaire :</label>
            <input type="text" name="core_secondary_stat_${setIndex}_${i}" value="${core.secondary_stat}">
          </div>
          <hr>
        `;
      });
      fieldsContainer.innerHTML = html;
    }

    // Affiche le premier set au chargement
    renderArtefactFields(select.value);

    // Change les champs quand on change de set
    select.addEventListener('change', function() {
      renderArtefactFields(this.value);
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll(".edit-tab");
    const tabContents = document.querySelectorAll(".edit-tab-content");

    // Onglet actif par défaut (infos principales)
    tabs.forEach((tab, idx) => {
      if (tab.classList.contains("active")) {
        tabContents[idx].classList.add("active");
      } else {
        tabContents[idx].classList.remove("active");
      }
    });

    // Gestion du clic sur les onglets
    tabs.forEach((tab, idx) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tabContents.forEach((tc) => tc.classList.remove("active"));
        tab.classList.add("active");
        tabContents[idx].classList.add("active");
      });
    });
  });
</script>
