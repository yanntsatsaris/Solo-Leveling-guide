<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mon compte - {{ user.username }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/user_profile.css') }}"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='images/icon-onglet.png') }}"
    />
  </head>

  <body>
    {% include 'navbar.html' %}
    <div class="user-profile-container">
      <h2>Mon compte : {{ user.username }}</h2>
      <form method="POST" id="profile-form" autocomplete="off">
        <label>Email :</label>
        <input type="email" name="email" id="profile_email" value="{{ user.email }}" required />
        <label>Nouveau mot de passe :</label>
        <input type="password" name="password" id="password" placeholder="Laisser vide pour ne pas changer" />
        <label>Confirmer le mot de passe :</label>
        <input type="password" name="password_confirm" id="password_confirm" placeholder="Répéter le mot de passe" />
        <button type="submit" id="profile-submit">Mettre à jour</button>
        <div id="profile-error" class="form-error"></div>
      </form>

      {% if is_admin %}
      <hr />
      <h3>Administration</h3>
      <a href="/admin/effects" class="admin-btn">Gérer les effets de pannoplie</a>
      <a href="/admin/cores" class="admin-btn">Gérer les noyaux et effets</a>
      <!-- Ajoute d'autres liens d'administration ici -->
      {% endif %}
    </div>
    <script>
document.addEventListener("DOMContentLoaded", function() {
  const emailInput = document.getElementById('profile_email');
  const pwdInput = document.getElementById('password');
  const pwdConfirmInput = document.getElementById('password_confirm');
  const submitBtn = document.getElementById('profile-submit');
  const errorDiv = document.getElementById('profile-error');
  const form = document.getElementById('profile-form');

  function updateProfileError() {
    let errorMsg = "";
    const strictEmail = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    // Vérification email
    if (!strictEmail.test(emailInput.value)) {
      errorMsg += "Adresse mail invalide.<br>";
      submitBtn.disabled = true;
      emailInput.classList.add('input-error');
    } else {
      emailInput.classList.remove('input-error');
    }
    // Vérification mot de passe
    const pwd = pwdInput.value;
    const confirm = pwdConfirmInput.value;
    if ((pwd || confirm) && pwd !== confirm) {
      errorMsg += "Les mots de passe ne correspondent pas.";
      submitBtn.disabled = true;
      pwdConfirmInput.classList.add('input-error');
    } else {
      pwdConfirmInput.classList.remove('input-error');
    }
    // Si tout est bon, on active le bouton
    if (strictEmail.test(emailInput.value) && (pwd === confirm)) {
      submitBtn.disabled = false;
    }
    errorDiv.innerHTML = errorMsg;
  }

  emailInput.addEventListener('input', updateProfileError);
  pwdInput.addEventListener('input', updateProfileError);
  pwdConfirmInput.addEventListener('input', updateProfileError);

  form.onsubmit = function(e) {
    updateProfileError();
    if (submitBtn.disabled) {
      e.preventDefault();
    }
  };

  // Initial check
  updateProfileError();
});
    </script>
  </body>
</html>
