{% extends 'base.html' %}

{% block title %}Mon compte - {{ user.uid[0].decode() if user.uid and user.uid[0] is not none else '' }}{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user_profile.css') }}" />
{% endblock %}

{% block content %}
    <div class="user-profile-container">
        <h2>Mon compte : {{ user.uid[0].decode() if user.uid and user.uid[0] is not none else '' }}</h2>
        <form method="POST" id="profile-form" autocomplete="off">
            <label>Email :</label>
            <input type="email" name="email" id="profile_email" value="{{ user.email }}" placeholder="Entrez votre email" required />
            <label>Nouveau mot de passe :</label>
            <input type="password" name="password" id="password" placeholder="Laisser vide pour ne pas changer" />
            <label>Confirmer le mot de passe :</label>
            <input type="password" name="password_confirm" id="password_confirm" placeholder="Répéter le mot de passe" />
            <button type="submit" id="profile-submit">Mettre à jour</button>
            <div id="profile-error" class="form-error"></div>
        </form>

        {% if is_admin and user.uid[0].decode() == session['username'] %}
        <hr />
        <h3>Administration</h3>
        <a href="{{ url_for('admin.admin_panoplie') }}" class="admin-btn">Gérer les panoplies</a>
        <a href="{{ url_for('admin.admin_cores') }}" class="admin-btn">Gérer les noyaux et effets</a>
        <!-- Ajoute d'autres liens d'administration ici -->
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const emailInput = document.getElementById('profile_email');
            const pwdInput = document.getElementById('password');
            const pwdConfirmInput = document.getElementById('password_confirm');
            const submitBtn = document.getElementById('profile-submit');
            const errorDiv = document.getElementById('profile-error');
            const form = document.getElementById('profile-form');

            let emailTouched = false;
            let pwdTouched = false;
            let pwdConfirmTouched = false;

            function updateProfileError() {
                let errorMsg = "";
                const strictEmail = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;

                if (emailTouched) {
                    if (!strictEmail.test(emailInput.value)) {
                        errorMsg += "Adresse mail invalide.<br>";
                        emailInput.classList.add('input-error');
                    } else {
                        emailInput.classList.remove('input-error');
                    }
                } else {
                    emailInput.classList.remove('input-error');
                }

                const pwd = pwdInput.value;
                const confirm = pwdConfirmInput.value;
                if ((pwdTouched || pwdConfirmTouched) && (pwd || confirm)) {
                    if (pwd !== confirm) {
                        errorMsg += "Les mots de passe ne correspondent pas.";
                        pwdConfirmInput.classList.add('input-error');
                    } else {
                        pwdConfirmInput.classList.remove('input-error');
                    }
                } else {
                    pwdConfirmInput.classList.remove('input-error');
                }

                if (
                    (emailTouched && !strictEmail.test(emailInput.value)) ||
                    ((pwdTouched || pwdConfirmTouched) && pwd !== confirm)
                ) {
                    submitBtn.disabled = true;
                } else {
                    submitBtn.disabled = false;
                }
                errorDiv.innerHTML = errorMsg;
            }

            emailInput.addEventListener('input', function() {
                emailTouched = true;
                updateProfileError();
            });
            pwdInput.addEventListener('input', function() {
                pwdTouched = true;
                updateProfileError();
            });
            pwdConfirmInput.addEventListener('input', function() {
                pwdConfirmTouched = true;
                updateProfileError();
            });

            form.onsubmit = function(e) {
                updateProfileError();
                if (submitBtn.disabled) {
                    e.preventDefault();
                }
            };
        });
    </script>
{% endblock %}
