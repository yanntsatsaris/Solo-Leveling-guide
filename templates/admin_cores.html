<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Noyaux</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_cores.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partials/edit_cores_modal.css') }}">
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='images/icon-onglet.png') }}"
    />
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container">
        <h1>Gestion des Noyaux</h1>
        <div style="text-align:center; margin-bottom: 24px;">
            <button id="create-core-btn" class="admin-btn">Créer un nouveau noyaux</button>
        </div>
        <table>
            <tr>
                <th>Image</th>
                <th>Couleur</th>
                <th>Numero</th>
            </tr>
            {% for core in cores %}
            <tr>
                <td>
                    {% if core.image %}
                        <a href="#" data-core-name="{{ core.color }}">
                            <img src="{{ core.image }}" alt="{{ core.color }}">
                        </a>
                    {% else %}
                        <span style="color:#ff3333;">Aucune image</span>
                    {% endif %}
                </td>
                <td>{{ core.color }}</td>
                <td>{{ core.number }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% include 'partials/edit_cores_modal.html' %}
    <script>
document.addEventListener("DOMContentLoaded", function() {
  // Ouvre la modale d'édition d'un core
  document.querySelectorAll('a[data-core-name]').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const color = this.getAttribute('data-core-name');
      // On récupère le numéro dans la même ligne du tableau
      const number = this.closest('tr').querySelector('td:nth-child(3)').textContent.trim();
      fetch(`/admin/cores/api/${encodeURIComponent(color)}/${number}`)
        .then(resp => resp.json())
        .then(data => {
          const langDiv = document.getElementById('edit-core-languages');
          langDiv.innerHTML = '';
          ['FR-fr', 'EN-en'].forEach(function(lang) {
            const effect = data[lang] || {};
            langDiv.innerHTML += `
              <fieldset>
                <legend>${lang}</legend>
                <label>Nom :</label>
                <input type="text" name="name_${lang}" value="${effect.name || ''}" required>
                <label>Effet :</label>
                <textarea name="effect_${lang}" class="effect-input">${effect.effect || ''}</textarea>
              </fieldset>
            `;
          });
          document.getElementById('edit-core-overlay').style.display = 'flex';
          document.getElementById('edit-core-form').action = `/admin/cores/${encodeURIComponent(color)}/${number}`;
          autoResizeAllTextareas();
        });
    });
  });

  // Fermer la modale en cliquant sur la croix
  document.getElementById('close-edit-core').onclick = function() {
    document.getElementById('edit-core-overlay').style.display = 'none';
  };

  // Fermer la modale en cliquant en dehors du menu
  document.getElementById('edit-core-overlay').addEventListener('mousedown', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });

  // Fermer la modale avec la touche Échap
  document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      document.getElementById('edit-core-overlay').style.display = 'none';
    }
  });

  // Création d'un nouveau core
  document.getElementById('create-core-btn').onclick = async function() {
    let color = prompt("Couleur du noyau ?");
    if (!color) return;
    let number = prompt("Numéro du noyau ? (ex: 01, 02, ...)");
    if (!number || !/^\d{2}$/.test(number)) {
      alert("Numéro invalide. Il doit être sur 2 chiffres (ex: 01, 02, ...)");
      return;
    }

    // Vérifie si le core existe déjà
    let exists = false;
    {% for core in cores %}
      if ("{{ core.color|e }}" === color && "{{ core.number|e }}" === number) exists = true;
    {% endfor %}
    if (exists) {
      alert("Un noyau avec cette couleur et ce numéro existe déjà !");
      return;
    }

    // Vérifie la présence de l'image
    let imgPath = `/static/images/Noyaux/${color}${number}.webp`;
    let imgExists = await fetch(imgPath, {method: "HEAD"}).then(r => r.ok).catch(() => false);
    if (!imgExists) {
      alert("Aucune image trouvée pour ce noyau !");
      return;
    }

    // Prépare la modale vide pour FR et EN
    document.getElementById('edit-core-form').setAttribute('data-mode', 'create');
    const langDiv = document.getElementById('edit-core-languages');
    langDiv.innerHTML = '';
    ['FR-fr', 'EN-en'].forEach(function(lang) {
      langDiv.innerHTML += `
        <fieldset>
          <legend>${lang}</legend>
          <label>Nom :</label>
          <input type="text" name="name_${lang}" value="" required>
          <label>Effet :</label>
          <textarea name="effect_${lang}" class="effect-input"></textarea>
        </fieldset>
      `;
    });
    document.getElementById('edit-core-overlay').style.display = 'flex';
    document.getElementById('edit-core-form').action = `/admin/cores/${encodeURIComponent(color)}/${number}`;
    autoResizeAllTextareas();
  };

  // Soumission du formulaire de création (PUT)
  document.getElementById('edit-core-form').onsubmit = async function(e) {
    const mode = this.getAttribute('data-mode');
    if (mode === "edit") return; // édition classique (POST)
    e.preventDefault();
    const url = this.action;
    const names = {};
    const effects = {};
    document.querySelectorAll('#edit-core-languages fieldset').forEach(fs => {
      const lang = fs.querySelector('legend').textContent;
      names[lang] = fs.querySelector(`input[name="name_${lang}"]`).value;
      effects[lang] = fs.querySelector(`textarea[name="effect_${lang}"]`).value;
    });
    const resp = await fetch(url, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({names, effects})
    });
    if (resp.ok) {
      location.reload();
    } else {
      alert("Erreur lors de la création du noyau.");
    }
  };
});
function autoResizeAllTextareas() {
  document.querySelectorAll("textarea.effect-input").forEach(function(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
  });
}
</script>
</body>
</html>